---
- name: Create Pulp storage directories
  ansible.builtin.file:
    path: "{{ item | split(':') | first }}"
    state: directory
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: "0755"
    setype: container_var_lib_t
  loop: "{{ pulp_volumes }}"

- name: Create Pulp storage subdirs
  ansible.builtin.file:
    path: "/var/lib/pulp/{{ item }}"
    state: directory
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: "0755"
    setype: container_var_lib_t
  loop:
    - tmp
    - assets
    - media

- name: Generate Django secret key
  ansible.builtin.copy:
    content: "{{ lookup('pipe', 'openssl rand -base64 50 | tr -d \"\\n\" | tr \"+/\" \"-_\"') }}"
    dest: /var/lib/pulp/django_secret_key
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0600'
    setype: container_var_lib_t
    force: false

- name: Generate database symmetric key
  ansible.builtin.copy:
    content: "{{ lookup('pipe', 'openssl rand -base64 32 | tr \"+/\" \"-_\"') }}"
    dest: /var/lib/pulp/database_fields.symmetric.key
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0600'
    setype: container_var_lib_t
    force: false

- name: Set Pulp directory ownership for container UID/GID
  ansible.builtin.shell: |
    cd /tmp
    sudo -u {{ foremanctl_user }} \
      podman unshare chown -R {{ pulp_container_uid }}:{{ pulp_container_gid }} /var/lib/pulp
  args:
    executable: /bin/bash
  changed_when: true

- name: Pull Pulp images and create secrets
  become: true
  become_user: "{{ foremanctl_user }}"
  block:
    - name: Pull the Pulp API container image
      containers.podman.podman_image:
        name: "{{ pulp_api_image }}"
        state: present

    - name: Pull the Pulp Content container image
      containers.podman.podman_image:
        name: "{{ pulp_content_image }}"
        state: present

    - name: Pull the Pulp Worker container image
      containers.podman.podman_image:
        name: "{{ pulp_worker_image }}"
        state: present

    - name: Create DB password secret
      containers.podman.podman_secret:
        state: present
        name: pulp-db-password
        data: "{{ pulp_database_password }}"
      notify:
        - Restart pulp-api
        - Restart pulp-content
        - Restart pulp-worker

    - name: Create django pulp secret key secret
      containers.podman.podman_secret:
        state: present
        name: pulp-django-secret-key
        path: /var/lib/pulp/django_secret_key
      notify:
        - Restart pulp-api
        - Restart pulp-content
        - Restart pulp-worker

    - name: Create database symmetric key secret
      containers.podman.podman_secret:
        state: present
        name: pulp-symmetric-key
        path: /var/lib/pulp/database_fields.symmetric.key
      notify:
        - Restart pulp-api
        - Restart pulp-content
        - Restart pulp-worker

- name: Deploy Pulp API quadlet
  containers.podman.podman_container:
    name: "{{ pulp_api_container_name }}"
    image: "{{ pulp_api_image }}"
    state: quadlet
    quadlet_dir: "{{ foremanctl_quadlet_dir }}"
    sdnotify: true
    command: pulp-api
    network: host
    hostname: "pulp-api.{{ ansible_facts['fqdn'] }}"
    volumes: "{{ pulp_volumes }}"
    security_opt:
      - "label=disable"
    secrets:
      - 'pulp-symmetric-key,type=mount,target=/etc/pulp/certs/database_fields.symmetric.key'
      - 'pulp-db-password,type=env,target=PULP_DATABASES__default__PASSWORD'
      - 'pulp-django-secret-key,type=env,target=PULP_SECRET_KEY'
    env: "{{ pulp_settings_env }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=default.target foreman.target
        [Unit]
        PartOf=foreman.target
        Wants=redis.service postgresql.service
        After=redis.service postgresql.service
        [Service]
        Restart=always
        RestartSec=3
  notify: Restart pulp-api

- name: Deploy Pulp Content quadlet
  containers.podman.podman_container:
    name: "{{ pulp_content_container_name }}"
    image: "{{ pulp_content_image }}"
    state: quadlet
    quadlet_dir: "{{ foremanctl_quadlet_dir }}"
    sdnotify: true
    command: pulp-content
    network: host
    hostname: "pulp-content.{{ ansible_facts['fqdn'] }}"
    volumes: "{{ pulp_volumes }}"
    security_opt:
      - "label=disable"
    secrets:
      - 'pulp-symmetric-key,type=mount,target=/etc/pulp/certs/database_fields.symmetric.key'
      - 'pulp-db-password,type=env,target=PULP_DATABASES__default__PASSWORD'
      - 'pulp-django-secret-key,type=env,target=PULP_SECRET_KEY'
    env: "{{ pulp_settings_env }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=default.target foreman.target
        [Unit]
        PartOf=foreman.target
        Wants=redis.service postgresql.service
        After=redis.service postgresql.service
        [Service]
        Restart=always
        RestartSec=3
  notify: Restart pulp-content

- name: Deploy Pulp Worker Template quadlet
  containers.podman.podman_container:
    name: "{{ pulp_worker_container_name }}-%i"
    quadlet_filename: "{{ pulp_worker_container_name }}@"
    image: "{{ pulp_worker_image }}"
    state: quadlet
    quadlet_dir: "{{ foremanctl_quadlet_dir }}"
    command: pulp-worker
    network: host
    hostname: "pulp-worker-%i.{{ ansible_facts['fqdn'] }}"
    volumes: "{{ pulp_volumes }}"
    security_opt:
      - "label=disable"
    secrets:
      - 'pulp-symmetric-key,type=mount,target=/etc/pulp/certs/database_fields.symmetric.key'
      - 'pulp-db-password,type=env,target=PULP_DATABASES__default__PASSWORD'
      - 'pulp-django-secret-key,type=env,target=PULP_SECRET_KEY'
    env: "{{ pulp_settings_env }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=foreman.target pulp-worker.target
        [Unit]
        PartOf=pulp-worker.target foreman.target
        Wants=redis.service postgresql.service
        After=redis.service postgresql.service
        [Service]
        Restart=always
        RestartSec=3
        SyslogIdentifier={{ pulp_worker_container_name }}@%i
  notify: Restart pulp-worker

- name: Make quadlet files readable by foremanctl user
  ansible.builtin.file:
    path: "{{ foremanctl_quadlet_dir }}/{{ item }}"
    mode: '0644'
  loop:
    - "{{ pulp_api_container_name }}.container"
    - "{{ pulp_content_container_name }}.container"
    - "{{ pulp_worker_container_name }}@.container"

- name: Create Pulp Worker Container instances
  ansible.builtin.file:
    state: link
    src: "{{ foremanctl_quadlet_dir }}/{{ pulp_worker_container_name }}@.container"
    dest: "{{ foremanctl_quadlet_dir }}/{{ item }}.container"
  loop: "{{ pulp_worker_services }}"

- name: Create pulp-worker.target
  become: true
  become_user: "{{ foremanctl_user }}"
  ansible.builtin.copy:
    dest: "{{ foremanctl_systemd_user_dir }}/pulp-worker.target"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0644'
    content: |
      [Unit]
      Description=Pulp Worker Services
      [Install]
      WantedBy=foreman.target

- name: Run daemon reload to load service files
  ansible.builtin.command:
    cmd: "systemctl --machine={{ foremanctl_user }}@ --user daemon-reload"
  changed_when: true
  # Alternative approach using systemd module (requires become_user):
  # become: true
  # become_user: "{{ foremanctl_user }}"
  # ansible.builtin.systemd:
  #   daemon_reload: true
  #   scope: user

- name: Run Pulp database migrations
  become: true
  become_user: "{{ foremanctl_user }}"
  block:
    - name: Migrate the Pulp database
      containers.podman.podman_container:
        name: pulpcore-manager-migrate
        image: "{{ pulp_api_image }}"
        command: pulpcore-manager migrate --noinput
        detach: false
        network: host
        volumes: "{{ pulp_volumes }}"
        secrets:
          - 'pulp-symmetric-key,type=mount,target=/etc/pulp/certs/database_fields.symmetric.key'
          - 'pulp-db-password,type=env,target=PULP_DATABASES__default__PASSWORD'
        env: "{{ pulp_settings_database_env }}"

    - name: Ensure Pulp admin user exists
      containers.podman.podman_container:
        name: pulpcore-manager-admin-password
        image: "{{ pulp_api_image }}"
        command: pulpcore-manager reset-admin-password --random
        detach: false
        network: host
        volumes: "{{ pulp_volumes }}"
        secrets:
          - 'pulp-symmetric-key,type=mount,target=/etc/pulp/certs/database_fields.symmetric.key'
          - 'pulp-db-password,type=env,target=PULP_DATABASES__default__PASSWORD'
        env: "{{ pulp_settings_database_env }}"

- name: Flush handlers to restart services
  ansible.builtin.meta: flush_handlers

- name: Start Pulp services
  ansible.builtin.command:
    cmd: "systemctl --machine={{ foremanctl_user }}@ --user start {{ item }}"
  loop: "{{ pulp_all_services }}"
  changed_when: true
  # Alternative approach using systemd module (requires become_user):
  # become: true
  # become_user: "{{ foremanctl_user }}"
  # ansible.builtin.systemd:
  #   name: "{{ item }}"
  #   state: started
  #   scope: user
  # loop: "{{ pulp_all_services }}"

- name: Enable and start pulp-worker.target
  ansible.builtin.command:
    cmd: "systemctl --machine={{ foremanctl_user }}@ --user enable --now pulp-worker.target"
  changed_when: true
  # Alternative approach using systemd module (requires become_user):
  # become: true
  # become_user: "{{ foremanctl_user }}"
  # ansible.builtin.systemd:
  #   name: pulp-worker.target
  #   enabled: true
  #   state: started
  #   scope: user

- name: Gather service facts to find existing pulp-worker instances
  become: true
  become_user: "{{ foremanctl_user }}"
  ansible.builtin.service_facts:

- name: Build list of existing pulp-worker services
  ansible.builtin.set_fact:
    pulp_existing_workers: "{{ ansible_facts.services.keys() | select('match', '^' + pulp_worker_container_name + '@\\d+\\.service$') | list }}"

- name: Clean up old pulp-worker instances
  when:
    - pulp_existing_workers | length > 0
    - (item | regex_replace('^' + pulp_worker_container_name + '@(\\d+)\\.service$', '\\1') | int) > (pulp_worker_count | int)
  block:
    - name: Stop and disable old pulp-worker instances
      ansible.builtin.command:
        cmd: "systemctl --machine={{ foremanctl_user }}@ --user disable --now {{ item }}"
      loop: "{{ pulp_existing_workers }}"
      changed_when: true
      # Alternative approach using systemd module (requires become_user):
      # become: true
      # become_user: "{{ foremanctl_user }}"
      # ansible.builtin.systemd:
      #   name: "{{ item }}"
      #   enabled: false
      #   state: stopped
      #   scope: user
      # loop: "{{ pulp_existing_workers }}"

    - name: Remove container symlinks for old pulp-worker instances
      ansible.builtin.file:
        path: "{{ foremanctl_quadlet_dir }}/{{ item | regex_replace('\\.service$', '.container') }}"
        state: absent
      loop: "{{ pulp_existing_workers }}"
