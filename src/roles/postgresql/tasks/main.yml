---
- name: Create PostgreSQL storage directory
  ansible.builtin.file:
    path: "{{ postgresql_data_dir }}"
    state: directory
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0700'

- name: Set PostgreSQL directory ownership for container UID/GID
  ansible.builtin.shell: |
    cd /tmp
    sudo -u {{ foremanctl_user }} podman unshare chown -R {{ postgresql_container_uid }}:{{ postgresql_container_gid }} {{ postgresql_data_dir }}
  args:
    executable: /bin/bash
  changed_when: true

- name: Pull PostgreSQL container image and create secrets
  become: true
  become_user: "{{ foremanctl_user }}"
  block:
    - name: Pull PostgreSQL container image
      containers.podman.podman_image:
        name: "{{ postgresql_container_image }}:{{ postgresql_container_tag }}"
        state: present

    - name: Create Podman secret for PostgreSQL admin password
      containers.podman.podman_secret:
        name: postgresql-admin-password
        data: "{{ postgresql_admin_password }}"
      notify:
        - Restart postgresql

- name: Deploy PostgreSQL quadlet
  containers.podman.podman_container:
    name: "{{ postgresql_container_name }}"
    image: "{{ postgresql_container_image }}:{{ postgresql_container_tag }}"
    state: quadlet
    quadlet_dir: "{{ foremanctl_quadlet_dir }}"
    healthcheck: pg_isready
    sdnotify: healthy
    network: host
    volumes:
      - "{{ postgresql_data_dir }}:/var/lib/pgsql/data:Z"
    secrets:
      - 'postgresql-admin-password,target=POSTGRESQL_ADMIN_PASSWORD,type=env'
    env:
      POSTGRESQL_MAX_CONNECTIONS: "{{ postgresql_max_connections }}"
      POSTGRESQL_SHARED_BUFFERS: "{{ postgresql_shared_buffers }}"
      POSTGRESQL_EFFECTIVE_CACHE_SIZE: "{{ postgresql_effective_cache_size }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=default.target foreman.target
        [Unit]
        PartOf=foreman.target

# - name: Make quadlet file readable by foremanctl user
#   ansible.builtin.file:
#     path: "{{ foremanctl_quadlet_dir }}/{{ postgresql_container_name }}.container"
#     mode: '0644'

- name: DEBUG - Check quadlet file was created
  ansible.builtin.stat:
    path: "{{ foremanctl_quadlet_dir }}/{{ postgresql_container_name }}.container"
  register: postgresql_debug_quadlet_stat

- name: DEBUG - Display quadlet file info
  ansible.builtin.debug:
    msg: |
      Quadlet file: {{ foremanctl_quadlet_dir }}/{{ postgresql_container_name }}.container
      Exists: {{ postgresql_debug_quadlet_stat.stat.exists }}
      Mode: {{ postgresql_debug_quadlet_stat.stat.mode | default('N/A') }}
      Owner: {{ postgresql_debug_quadlet_stat.stat.pw_name | default('N/A') }}
      Group: {{ postgresql_debug_quadlet_stat.stat.gr_name | default('N/A') }}
      Readable: {{ postgresql_debug_quadlet_stat.stat.readable | default('N/A') }}

# - name: DEBUG - Test quadlet file readability as foremanctl user
#   become: true
#   become_user: "{{ foremanctl_user }}"
#   ansible.builtin.command: cat {{ foremanctl_quadlet_dir }}/{{ postgresql_container_name }}.container
#   register: postgresql_debug_cat_result
#   failed_when: false
#   changed_when: false

# - name: DEBUG - Display readability test result
#   ansible.builtin.debug:
#     msg: |
#       Can foremanctl user read quadlet file: {{ postgresql_debug_cat_result.rc == 0 }}
#       {% if postgresql_debug_cat_result.rc != 0 %}
#       Error: {{ postgresql_debug_cat_result.stderr }}
#       {% endif %}

- name: DEBUG - Check quadlet directory permissions
  ansible.builtin.stat:
    path: "{{ foremanctl_quadlet_dir }}"
  register: postgresql_debug_quadlet_dir_stat

- name: DEBUG - Display quadlet directory info
  ansible.builtin.debug:
    msg: |
      Quadlet directory: {{ foremanctl_quadlet_dir }}
      Mode: {{ postgresql_debug_quadlet_dir_stat.stat.mode }}
      Owner: {{ postgresql_debug_quadlet_dir_stat.stat.pw_name }}
      Group: {{ postgresql_debug_quadlet_dir_stat.stat.gr_name }}
      Executable: {{ postgresql_debug_quadlet_dir_stat.stat.executable }}

# - name: Activate PostgreSQL service
#   become: true
#   become_user: "{{ foremanctl_user }}"
#   block:
#     - name: Run daemon reload
#       ansible.builtin.systemd:
#         daemon_reload: true
#         scope: user

#     - name: Flush handlers to restart services
#       ansible.builtin.meta: flush_handlers

#     - name: Start the PostgreSQL Service
#       ansible.builtin.systemd:
#         name: "{{ postgresql_container_name }}"
#         state: started
#         scope: user

- name: Run daemon reload
  ansible.builtin.command:
    cmd: "systemctl --machine={{ foremanctl_user }}@ --user daemon-reload"

- name: Flush handlers to restart services
  ansible.builtin.meta: flush_handlers

- name: Start the PostgreSQL Service
  # environment:
  #   XDG_RUNTIME_DIR: "/run/user/{{ ansible_facts['getent_passwd'][foremanctl_user][1] }}"
  ansible.builtin.systemd:
    name: "{{ postgresql_container_name }}"
    state: started
    scope: user

# SCRAM-SHA-256 is default for PostgreSQL 14+,
# after the upgrade, we can drop this task.
- name: Use scram-sha-256 for password encryption
  community.postgresql.postgresql_set:
    login_user: postgres
    login_password: "{{ postgresql_admin_password }}"
    login_host: localhost
    name: password_encryption
    value: "scram-sha-256"
  notify:
    - Restart postgresql

- name: Create PostgreSQL users
  community.postgresql.postgresql_user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    login_user: postgres
    login_password: "{{ postgresql_admin_password }}"
    login_host: localhost
    role_attr_flags: "{{ item.role_attr_flags | default(omit) }}"
    state: present
  loop: "{{ postgresql_users }}"
  no_log: true

- name: Create PostgreSQL databases
  community.postgresql.postgresql_db:
    name: "{{ item.name }}"
    owner: "{{ item.owner }}"
    login_user: postgres
    login_password: "{{ postgresql_admin_password }}"
    login_host: localhost
    state: present
  loop: "{{ postgresql_databases }}"
